name: Publish to AUR

on:
  workflow_dispatch:

jobs:
  update-aur:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from release
        id: version
        shell: bash
        run: |
          set -euo pipefail
          
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION=$(curl -sf "https://api.github.com/repos/${{ github.repository }}/releases/latest" | jq -r '.tag_name')
          fi
          
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Detected version: $VERSION"

      - name: Download CLAP from release
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p downloads
          
          DOWNLOADED=false
          for TAG in "$VERSION" "v$VERSION"; do
            URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/Vitsel-linux.clap"
            if curl --output /dev/null --silent --head --fail "$URL"; then
              wget -O "downloads/Vitsel-linux.clap" "$URL"
              DOWNLOADED=true
              break
            fi
          done
          
          if [[ "$DOWNLOADED" != "true" ]]; then
            echo "Failed to download CLAP binary"
            exit 1
          fi

      - name: Calculate SHA256 checksum
        id: checksums
        shell: bash
        run: |
          set -euo pipefail
          HASH=$(sha256sum "downloads/Vitsel-linux.clap" | cut -d ' ' -f 1)
          echo "hash=$HASH" >> "$GITHUB_OUTPUT"

      - name: Create PKGBUILD
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          HASH="${{ steps.checksums.outputs.hash }}"
          
          mkdir -p aur-package
          cat > aur-package/PKGBUILD << 'EOF'
          # Maintainer: MLM-stuff <gfxoxinzh@mozmail.com>
          pkgname=vitsel-clap-bin
          _pkgname=vitsel
          pkgver={{VER}}
          pkgrel=1
          pkgdesc="Minimal Rust CLAP synth with PolyBLEP oscillators, ADSR, and zero-delay TPT SVF"
          arch=('x86_64')
          url="https://github.com/mlm-games/vitsel-clap"
          license=('MIT')
          depends=('glibc')
          optdepends=('clap-host: A CLAP host to load the plugin (not required by yadaw)')
          provides=('vitsel-clap')
          conflicts=('vitsel-clap')
          options=('!strip')

          source=("Vitsel-${pkgver}.clap::https://github.com/mlm-games/vitsel-clap/releases/download/v${pkgver}/Vitsel-linux.clap")
          sha256sums=('{{HASH}}')

          package() {
            install -Dm755 "${srcdir}/Vitsel-${pkgver}.clap" \
              "${pkgdir}/usr/lib/clap/Vitsel.clap"
          }
          EOF

          sed -i "s/{{VER}}/${VERSION}/g" aur-package/PKGBUILD
          sed -i "s/{{HASH}}/${HASH}/g" aur-package/PKGBUILD
          
          echo "Generated PKGBUILD:"
          cat aur-package/PKGBUILD

      - name: Publish to AUR
        uses: mlm-games/aur-deploy-action@master
        with:
          pkgname: vitsel-clap-bin
          pkgbuild: aur-package/PKGBUILD
          auto_pkgrel: 'true'
          commit_username: MLM-stuff
          commit_email: gfxoxinzh@mozmail.com
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to v${{ steps.version.outputs.version }}"
